---
title: "Final Exam"
subtitle: "BIOS 684"
author: "Jeff Oliver"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  pdf_document:
  latex_engine: xelatex
---

```{r setup, include=FALSE, fig.height = 4}
knitr::opts_chunk$set(echo = FALSE, dev = "pdf")
library("dplyr")
library("tidyr")
library("ggplot2")
# library("lmtest")
library("gee")
# library("geepack")
# library("contrast")
library("aods3")
library("lme4")
# library("alr")
```

## Question 1
<!--
The question concerns the analysis of a subset of data from a clinical trial which randomized patients with arthritis to one of two treatments: auranofin (A) or placebo (P). The data provided are from a subset of 51 patients. The outcome measure of interest is a binary self-assessment of arthritis status (0=poor, 1=good). The self-assessments were scheduled at weeks -1 and 0, and then at weeks 4, 8 and 12. Randomization occurred immediately after the week 0 assessment. The primary objective of the analysis is to compare the effects of auranofin and placebo on self-assessed arthritis status. 
The data from this study are stored in the file arthritis.txt, which can be found on the course web site. Each row of the data set contains the following variables: subject ID number, sex (M=male, F=female), subject’s age in years at entry to the study, the randomized treatment group (A or P), and the self-assessment results at weeks -1, 0, 4, 8 and 12, respectively. Although the subjects’ ages are provided, these data are not used in any question.
-->

```{r read-arthritis-data}
# Read data from file
arthritis.data <- read.delim(file = "data/arthritis.txt", 
                             header = FALSE,
                             sep = " ", 
                             na.strings = ".")
# Assign column names
colnames(arthritis.data) <- c("id", "sex", "age", "treatment", "r.n1", "r.0", "r.4", "r.8", "r.12")

# Re-level treatment so placebo is default
arthritis.data$treatment <- factor(arthritis.data$treatment, levels = c("P", "A"))

# Tranform to long format
arthritis.long <- gather(data = arthritis.data, 
                         key = "week.cat", 
                         value = "status",
                         -id, -sex, -age, -treatment)

# Add numeric week column
arthritis.long$week <- NA
arthritis.long$week[arthritis.long$week.cat == "r.n1"] <- -1
arthritis.long$week[arthritis.long$week.cat == "r.0"] <- 0
arthritis.long$week[arthritis.long$week.cat == "r.4"] <- 4
arthritis.long$week[arthritis.long$week.cat == "r.8"] <- 8
arthritis.long$week[arthritis.long$week.cat == "r.12"] <- 12
```

### 1. Briefly summarize the outcome data from the study in a single table. Specifically, show for each treatment group at each scheduled assessment: how many provided an assessment and what number and percentage rated their arthritis status as “good”. 
```{r summary-arthritis-data}
arthritis.table <- arthritis.long %>%
  group_by(treatment, week) %>%
  summarise(count = sum(!is.na(status)),
            num.good = sum(status == 1, na.rm = TRUE))
arthritis.table$perc.good <- 100 * (round(arthritis.table$num.good / arthritis.table$count, 4))
```

| Treatment | Week | # Assessments | # "good" | % "good"^1^ |
|:----------|:-----|:-------------:|:--------:|:----------:|
| Auranofin | -1   | `r arthritis.table$count[1]` | `r arthritis.table$num.good[1]` | `r arthritis.table$perc.good[1]` |
|           | 0    | `r arthritis.table$count[2]` | `r arthritis.table$num.good[2]` | `r arthritis.table$perc.good[2]` |
|           | 4    | `r arthritis.table$count[3]` | `r arthritis.table$num.good[3]` | `r arthritis.table$perc.good[3]` |
|           | 8    | `r arthritis.table$count[4]` | `r arthritis.table$num.good[4]` | `r arthritis.table$perc.good[4]` |
|           | 12   | `r arthritis.table$count[5]` | `r arthritis.table$num.good[5]` | `r arthritis.table$perc.good[5]` |
| Placebo   | -1   | `r arthritis.table$count[6]` | `r arthritis.table$num.good[6]` | `r arthritis.table$perc.good[6]` |
|           | 0    | `r arthritis.table$count[7]` | `r arthritis.table$num.good[7]` | `r arthritis.table$perc.good[7]` |
|           | 4    | `r arthritis.table$count[8]` | `r arthritis.table$num.good[8]` | `r arthritis.table$perc.good[8]` |
|           | 8    | `r arthritis.table$count[9]` | `r arthritis.table$num.good[9]` | `r arthritis.table$perc.good[9]` |
|           | 12   | `r arthritis.table$count[10]` | `r arthritis.table$num.good[10]` | `r arthritis.table$perc.good[10]` |
^1^Note the percent of "good" responses is based on number of assessments returned, _not_ the total number of subjects for that treatment / week combination.

#### Based on the descriptive statistics in the table, briefly characterize the pattern of change in the proportions over time including a comparison of the two treatments.

```{r plot-arthritis-status, fig.height = 3}
status.plot <- ggplot(data = arthritis.table, mapping = aes(x = week, y = perc.good, group = treatment, color = treatment)) +
  geom_line() +
  ylab(label = "% \"Good\"") +
  xlab(label = "Week") +
  scale_color_manual(name = "Treatment", values = c("#4444EC", "#EC4444"), labels = c("Placebo", "Auranofin"))
print(status.plot)
```
Ignoring potential effects of age and sex, the percent of subjects self-reporting a "good" status appears to diverge between the two treatments. In the placebo treatment, the percent of subjects with "good" status _decreases_ dramatically over weeks -1 through 4, then increases over weeks 4 through 12. In contrast, the Auranofin treatment showed _increases_ in the percent reporting "good" status over weeks -1 through 4, followed by a decrease between weeks 4 and 8, then a slight increase between weeks 8 and 12.

#### Is the study design balanced with respect to the timing of measurements? Briefly justify your answer. 

The study _design_ is balanced with respect to the timing of measurements, as there are the same number of measurements, made at the same time, across all subjects.

#### Are the data complete? Briefly justify your answer. 

The data are not complete; not all subjects have a complete set of all observations.

#### Characterize the pattern of change over time in the proportion with a “good” status by sex.

```{r arthritis-status-by-sex-over-time, fig.height = 3}
by.sex.table <- arthritis.long %>%
  group_by(treatment, week, sex) %>%
  summarize(count = sum(!is.na(status)),
            num.good = sum(status == 1, na.rm = TRUE))
by.sex.table$prop.good <- round((by.sex.table$num.good / by.sex.table$count), 3)

sex.names <- c(F = "Female", M = "Male")
status.by.sex.plot <- ggplot(data = by.sex.table, 
                             mapping = aes(x = week, 
                                           y = prop.good, 
                                           group = treatment, 
                                           color = treatment)) +
  geom_line() +
  facet_grid(. ~ sex, labeller = labeller(sex = sex.names)) +
  ylab(label = "Prop. \"Good\"") +
  xlab(label = "Week") +
  scale_color_manual(name = "Treatment", 
                     values = c("#4444EC", "#EC4444"), 
                     labels = c("Placebo", "Auranofin"))
print(status.by.sex.plot)
```

There are strikingly different patterns of change over time in the proportion of subjects with a "good" status between females and males. In the placebo treatment, there is a general decrease in the proportion of female subjects reporting "good" status, showing an increase only in the week 4 to week 8 period. The proportion of males reporting a "good" status in the placebo treatment shows an initial decrease (weeks -1 through 4), followed by an increase (weeks 4 through 12). In the Auranofin treatment, females had a sharp increase in the proportion of subjects with "good" status (weeks -1 through 4), followed by a decrease (weeks 4 through 12). Males in the Auranofin treatment showed a general increase in the proportion of subjects with "good" status, except for the week -1 to 0 period, where the proportion was constant and the week 4 to 8 period, where the proportion decreased. The pattern of change over time for males appears more similar to the trend when sex is ignored (previous plot), likely reflecting the fact that the study included more males than females.

<!--
In the following questions, use PROC GENMOD in SAS to fit marginal logistic regression models using the approach of generalized estimating equations (GEE) to obtain parameter estimates. The time variable, T, is defined to be the categorical variable with 4 levels: taking the value 99 for measurements at weeks -1 and 0 (i.e. for both “baseline” measurements prior to randomization) and values 4, 8 and 12 for the measurements at weeks 4, 8 and 12. The treatment variable, X, is an indicator variable taking the value 1 if a subject received auranofin (A) and the value 0 if placebo (P). The study investigator suggests fitting a marginal logistic regression model for the repeated arthritis self-assessment measurements as the outcome variable and with the T variable and a T*X interaction variable as categorical explanatory variables. He suggests using an independence working correlation matrix to describe the within-subject correlation structure (i.e. using the TYPE=IND on the REPEATEDstatement).
-->
```{r data-prep-1.2}
# Setup variables for GEE
# Using time instead of T, because T is reserved (TRUE)
arthritis.long$time <- arthritis.long$week
arthritis.long$time[arthritis.long$time %in% c(-1, 0)] <- 99
arthritis.long$time <- factor(arthritis.long$time, levels = c(99, 4, 8, 12))

# X is indicator of treatment (0 = P(lacebo), 1 = A(uranofin))
arthritis.long$X <- 0
arthritis.long$X[arthritis.long$treatment == "A"] <- 1
arthritis.long$X <- factor(arthritis.long$X, levels = c(0, 1))
```

### 2a. Define appropriate notation and write down the algebraic form for the model that will be fitted using the GEE method, including any assumptions.

**Assume**:

1. The mean response is conditional on covariates only (no random effects) and is assumed to be related to covariates through a known link function ($g(\cdot)$), which has a linear relationship with covariates:

$$
g(\mu_{ij}) = \beta_{1}X_{1ij} + \beta_{2}X_{2ij} + \beta_{3}X_{3ij} + ... + \beta_{p}X_{pij}
$$
where $\mu_{ij} = E(Y_{ij}|X_{ij})$.

2. The conditional variance is related to the mean by a known variance function ($v(\cdot)$) and scale parameter ($\phi$):

$$
Var(Y_{ij}|X_{ij}) = \phi v(\mu_{ij})
$$

3. The conditional association between responses of the same subject are a function of the mean an a set of association parameters, $\alpha$. 

Additional assumption: Data are missing completely at random (MCAR).

**Model definition**

1. Link function:
$$
logit(\mu_{ij}) = \beta_1 + \beta_2 T_{i2} + \beta_3 T_{i3} + \beta_4 T_{i4} + \beta_5 T_{i1} \times X_i + \beta_6 T_{i2} \times X_i + \beta_7 T_{i3} \times X_i + \beta_8 T_{i4} \times X_i
$$
Where:
$$
\begin{array}{l}
  T_{i1} = 
  \begin{cases}
      1, & \text{if measurement taken at weeks -1 or 0} \\
      0, & \text{otherwise}
  \end{cases} \\
  T_{i2} = 
  \begin{cases}
      1, & \text{if measurement taken at week 4} \\
      0, & \text{otherwise}
  \end{cases} \\
  T_{i3} = 
  \begin{cases}
      1, & \text{if measurement taken at week 8} \\
      0, & \text{otherwise}
  \end{cases} \\
  T_{i4} = 
  \begin{cases}
      1, & \text{if measurement taken at week 12} \\
      0, & \text{otherwise}
  \end{cases} \\
  X_i = 
  \begin{cases}
      1, & \text{Subject in Auranofin treatment} \\
      0, & \text{Subject in placebo treatment}
  \end{cases} \\
\end{array}
$$
Note $T_{i2}$ is included only in an interaction effect ($T_{i2} \times X_i$). This is because R will create a coefficient for every level of a factor in an interaction term. See more details in the answer to 3(a).

2. Variance

$$
Var(Y_{ij}|X_{ij}) = \mu_{ij}(1 - \mu_{ij}) \enspace \text{(Bernoulli variance, assuming no overdispersion, }\phi = 1 \text{)}
$$
3. Within-subject association has an "independent" structure for the working correlation:

$$
Corr(Y_{ij}, Y_{ik}) = 
\begin{cases}
  1, & j = k \\
  0, & j \neq k
\end{cases}
$$

#### b. The model includes the variable T as a main effect. What is being assumed about subjects’ arthritis status at weeks -1 and 0? Briefly critique this assumption.

This assumption effectively ignores within-subject variation between weeks -1 and 0. While there may not be an _a priori_ reason to expect a change over this pre-randomization period, information about within-subject variation is unnecessarily discared. This _might_ lead to mis-specifying the correlation structure of within-subject associations. Misspecification of the covariance structure has the potential to reduce the power of the analysis.

#### c. The model does not include the variable X as a main effect. What assumption is therefore being made? Briefly describe why this assumption is reasonable in this study.

The assumption is that subjects assigned to placebo treatment have the same expected probability of reporting "good" arthritis status as subjects assigned to the Auranofin treatment _before_ the treatment is actually applied ($Pr(Y = "good"|X = 0, T = 99)) = Pr(Y = "good"|X = 1, T = 99)$). This is a reasonable assumption because it is a randomized trial.

#### d. In using the GEE method in the presence of missing data, the assumption of missingness completely at random (MCAR) is required. In 1-2 sentences, describe what this means about the missing assessments.

Missing completely at random means that the probability that an observation is missing is independent of the value of observations that are made ($Y^O$) and the value of observations that are missing ($Y^M$). This is in contrast to assumption of data missing at random (MAR), where the probability that an observation is missing is dependent on the values that _were_ observed ($Y^O$), but unrelated to the values that are actually missing ($Y^M$).

#### Are there any features of the study dataset that might lead you to question this?
```{r dropouts-over-time}
dropouts <- colSums(apply(X = arthritis.data[, 5:9], MARGIN = 2, FUN = is.na))
```
The increasing number of missing observations over time suggests that subjects _might_ have skipped observations based on whether or not they would have reported "good" status. If so, this would indicate data are NMAR (where the probability of missing data is dependent on the values that are missing, $Y^M$), which would be less than ideal.

| Week | # Missing       |
|:----:|:---------------:|
| -1   | `r dropouts[1]` |
| 0    | `r dropouts[2]` |
| 4    | `r dropouts[3]` |
| 8    | `r dropouts[4]` |
| 12   | `r dropouts[5]` |

<!--In all questions that follow, assume that MCAR is reasonable.-->

### 3a. Fit the model described in question 2 using PROC GENMOD. Provide the PROC GENMOD code used and the estimates of the parameters in the mean part of the model obtained as well as empirical standard errors for these estimates. 
<!--[HINT: Add “/ param=ref “ after your list of variables in your class statement to ensure that SAS doesn’t try to outsmart you and add main effects of X back into the model].-->

```{r marginal-model-arthritis, echo = TRUE}
arthritis.gee <- suppressMessages(gee(status ~ time + time:X,
                     id = id,
                     data = arthritis.long,
                     family = binomial,
                     corstr = "independence"))
arthritis.gee.summary <- summary(arthritis.gee)
arthritis.gee.coef <- coef(arthritis.gee.summary)
coef.table <- data.frame(arthritis.gee.coef)
coef.table$p <- 2*pnorm(q = abs(arthritis.gee.coef[,5]), lower.tail = FALSE)
coef.table <- round(coef.table, 3)
```
Note: Using `formula = status ~ time + time*X` excludes the `time99:timeX1` term, but brings in the main effect of X into the model. By default, R uses reference level coding (and this is true apparently for `gee`, which has `contr.treatment` for both `time` and `X` in the `contrasts` element of the `gee` output), which is what the `PARAM = REF` command in the `CLASS` Statement of `PROC GENMOD` appears to be doing.

Parameter estimates and empirical ("robust") standard errors:

| Coefficient | Covariate  | Estimate                   | Standard Error                | $P(\beta = 0)$ |
|:-----------:|:-----------|:--------------------------:|:-----------------------------:| :------------------:|
| $\beta_1$   | Intercept  | `r coef.table$Estimate[1]` | `r coef.table$Robust.S.E.[1]` | `r coef.table$p[1]` |
| $\beta_2$   | Time = 4   | `r coef.table$Estimate[2]` | `r coef.table$Robust.S.E.[2]` | `r coef.table$p[2]` |
| $\beta_3$   | Time = 8   | `r coef.table$Estimate[3]` | `r coef.table$Robust.S.E.[3]` | `r coef.table$p[3]` |
| $\beta_4$   | Time = 12  | `r coef.table$Estimate[4]` | `r coef.table$Robust.S.E.[4]` | `r coef.table$p[4]` |
| $\beta_5$   | Time99 * A | `r coef.table$Estimate[5]` | `r coef.table$Robust.S.E.[5]` | `r coef.table$p[5]` |
| $\beta_6$   | Time4 * A  | `r coef.table$Estimate[6]` | `r coef.table$Robust.S.E.[6]` | `r coef.table$p[6]` |
| $\beta_7$   | Time8 * A  | `r coef.table$Estimate[7]` | `r coef.table$Robust.S.E.[7]` | `r coef.table$p[7]` |
| $\beta_8$   | Time12 * A | `r coef.table$Estimate[8]` | `r coef.table$Robust.S.E.[8]` | `r coef.table$p[8]` |
For coefficients $\beta_5$ - $\beta_8$, the covariate is the interaction between time and treatment with Auranofin.

#### b. How is this model different from an ordinary logistic regression analysis that assumes that all observations are independent? Note here the question is not “how do the results from the two analyses differ for these data”, but how the models themselves differ – that is, why would they give different results. 

#TODO: Describe differences in estimates of error.

#### Which approach do you prefer and why?

#TODO: Marginal. Less opportunity for false positive (check)

### 4a. Include in your code a Wald test of the joint hypothesis that there is no effect of auranofin compared with placebo at all three of weeks 4, 8 and 12. Run this PROC GENMOD analysis and provide the PROC GENMOD code used, as well as the estimates of the parameters in the mean part of the model obtained, the standard errors for these estimates, p-values for tests that each parameter equals zero, and the p-value from the Wald test of joint hypothesis.
<!--[HINT: Use the TYPE3 and WALD options together on the MODEL statement]-->
<!-- For aods3::wald.test in R, specify the Terms to run the test for, not the L matrix-->

Testing $\beta_{6} = \beta_{7} = \beta_{8} = 0$ via $W^2 = (L\hat{\beta})'\{L\widehat{Cov}(\hat{\beta})L'\}^{-1}(L\hat{\beta})$, where:

$$
L\hat{\beta} = 
\begin{pmatrix}
  1 & 0 & 0 \\
  0 & 1 & 0 \\
  0 & 0 & 1
\end{pmatrix}
\begin{pmatrix}
  \hat{\beta_{6}} \\
  \hat{\beta_{7}} \\
  \hat{\beta_{8}}
\end{pmatrix}
$$

For this Wald test, I relied on the previous marginal model estimates and variance-covariance matrix. For parameter estimates, standard errors, and p-values of the $\beta=0$ for individual parameters, see table in the answer to 3(a), above.
```{r joint-wald-test, echo = TRUE}
# For the call to aods3::wald.test:
#   b     : The vector of parameter estimates (betas)
#   varb  : The variance-covariance matrix
#   Terms : Index of one ore more coefficients to test
arthritis.joint.wald <- wald.test(b = arthritis.gee.coef[, 1],
                                  varb = arthritis.gee$robust.variance,
                                  Terms = c(6:8))
```
For the joint hypothesis, $W^2 = `r round(arthritis.joint.wald$result$chi2["chi2"], 3)`$ and $p = `r round(arthritis.joint.wald$result$chi2["P"], 3)`$. We thus reject the null hypothesis of $\beta_{6} = \beta_{7} = \beta_{8} = 0$.

#### b. What do you conclude concerning the effect of auranofin versus placebo?
<!--[Note: do not just provide a p-value from the test of the joint hypothesis; instead provide a broader interpretation of the results concerning any treatment differences].-->

The proclivity for the average Auranofin subject's arthritis status to change over time is significantly different from the average subject in the placebo treatment. The joint Wald test of a post-baseline effect of Auranofin on arthritis status was significnat ($W^2 = `r round(arthritis.joint.wald$result$chi2["chi2"], 3)`$, $p = `r round(arthritis.joint.wald$result$chi2["P"], 3)`$). Additionally, in the test of individual time points, the effect of Auranofin treatment on the week 4 measurement was also significant, while effects of Auranofin treatment on other weeks were not.

#TODO: Add log-odds ratio (or something of that ilk) interpretation based on T4 * X estimate

#### c. The default test of the joint hypothesis within SAS (obtained by using the TYPE3 option without the WALD option) is not a Wald test. Review the SAS documentation and identify what type of test it is and why SAS uses it as the default rather than the Wald test.

#TODO: Check this

### 5. Another investigator questions whether it is appropriate to use an unstructured log odds ratio correlation structure. Now using PROC GENMOD, fit the same model but using an unstructured log odds ratio structure for the working association structure. Write out how your model formulation given in 2(a) changes under this alternative assumption. Describe whether the conclusions of your GEE analyses are sensitive to the change in association structure.

***
#QUESTION: How to do log odds ratio for correlation structure in R, AND what is the structure being used in 2(a) for the association structure?
***

unstructured log-odds ratio pattern:

$$
\text{log} OR(Y_{ij}, Y_{ik}|X_{ij}, X_{ik}) = \alpha_{jk}
$$
where

$$
OR(Y_{ij}, Y_{ik}) = \frac{Pr(Y_{ij} = 1, Y_{ik} = 1) \times Pr(Y_{ij} = 0, Y_{ik} = 0)}{Pr(Y_{ij} = 1, Y_{ik} = 0) \times Pr(Y_{ij} = 0, Y_{ik} = 1)}
$$


```{r log-odds, eval = FALSE}
# Modeled off example in genmod.R:

arthritis.gee.logOR <- alr(status ~ time + time:X,
                           id = id,
                           data = arthritis.long,
                           depm = "exchangeable",
                           ainit = 0.01)
arthritis.gee.logOR.coef <- coef(summary(arthritis.gee.logOR))

# Produces SE = 0 and Z = Inf for all coefficients
```

### 6. The investigator is interested in knowing whether the results comparing the effect of auranofin versus placebo on arthritis status over time is affected by any imbalance in sex between the treatment groups. Conduct analysis to address this specific issue. Briefly describe how you approached this (include your PROC GENMOD code) and what your key findings are.

```{r marginal-compare-sexes, echo = TRUE}
arthritis.s.gee <- suppressMessages(gee(status ~ sex + time + time:X,
                     id = id,
                     data = arthritis.long,
                     family = binomial,
                     corstr = "independence"))
arthritis.s.gee.coef <- data.frame(coef(summary(arthritis.s.gee)))
arthritis.s.gee.coef$p <- 2*pnorm(q = abs(arthritis.s.gee.coef[, 5]), lower.tail = FALSE)
```

#TODO: Describe the effect of sex (or lack thereof)

### 7. Summarize the objective, methods, results and conclusions of the study in an informative structured abstract suitable for a medical journal or conference (i.e. with sections under the headings: Objective, Methods, Results, Conclusions). Include key numerical results. The abstract should be no longer than 500 characters including spaces and cannot include tables or figures.

#TODO: Write abstract

## Question 2
### The investigator at Center=1 is interested in characterizing the distribution of risk among subjects at her center. _In the following, only include the subset of subjects with Center=1 in the analysis._
<!--
This question is based on the study that was featured in Homework 8. Briefly, recall that the Skin Cancer Prevention Study was a randomized, double-blind, placebo-controlled multi-center clinical trial designed to test the effectiveness of beta- carotene in the prevention of non-melanoma skin cancer in high-risk subjects. Subjects were randomized to either placebo or 50 mg of beta-carotene per day for 5 years. Subjects were examined once per year and the outcome variable, Y, is a count of the number of new skin cancers per year. 

Selected data from the study are in the dataset called “skin.txt” on the course web site. Each row of the dataset contains the following 9 variables: ID, Center, Age, Skin, Gender, Exposure, Y, Treatment, Year.
These variables take values as follows:
ID: Subject identifier number
Center: Identifier number for center of enrollment.
Age: Subject’s age in years at randomization
Skin: Skin type (1=burns; 0 otherwise) [evaluated at randomization and doesn’t
change with time]
Gender: 1=male; 0=female
Exposure: Count of number of previous skin cancers [prior to randomization]
Y: Count of number of new skin cancers in the Year of follow-up
Treatment: 1=beta-carotene; 0=placebo
Year: Year of follow-up after starting randomized treatment

As in HW8, you may assume that the counts of new skin cancers, Y, are from exact one-year periods (so that no offset term is needed). 
-->

```{r read-skin-data}
# Read data
skin.data <- read.delim(file = "data/skin.txt", sep = " ", header = FALSE)

# Trim first & last columns (created by whitespace)
skin.data <- skin.data[, -c(1, ncol(skin.data))]

# Identify columns
colnames(skin.data) <- c("id", "center", "age", "skin", "gender", "prior.count", "new.count", "treatment", "year")

# Drop data from center != 1
skin.data <- skin.data[skin.data$center == 1, ]

# Set factors as needed
factor.cols <- c("id", "center", "skin", "gender", "treatment")
for (c in factor.cols) {
  skin.data[, c] <- factor(skin.data[, c])
}
```

#### a) Provide an algebraic definition for a generalized linear marginal model in which the only effects are for the intercept and Year (as a continuous variable). Fit this model and provide a table from your SAS output which includes the estimates of the parameters in your model.

#TODO: Write out marginal model

```{r skin-gee, include = FALSE, echo = TRUE}
skin.gee <- gee(new.count ~ year,
                id = id,
                data = skin.data,
                family = poisson,
                corstr = "exchangeable")
skin.gee.summary <- summary(skin.gee)
skin.gee.coef <- coef(skin.gee.summary)
```

#TODO: Check the correlation structure for this model

#TODO: Calculate p-values for parameter estimates

#TODO: Create table with parameter estimates, standard errors, z-scores, p-values

#### b) Provide an algebraic definition for a generalized linear mixed model (GLMM) in which the only fixed effects are for the intercept and Year (as a continuous variable), and the only random effect is the intercept. What is being assumed about how the distribution of risk among subjects changes with time?

#TODO: Write out generalized linear mixed model

#TODO: Describe assumptions about distribution of risk among subjects as it changes with time (i.e. there are no random effects, right?)

#### c) Fit your chosen GLMM in SAS and provide the SAS code for the fitting the model (just provide the code from the PROC that you use). Provide a table from your SAS output which includes the estimates for the parameters in your GLMM, and provide careful interpretation of the Year term.

<!-- see examples/depress.R -->

```{r skin-glmm, echo = TRUE}

# Use nAGQ > 1 for better accuracy
skin.glmer <- glmer(new.count ~ 1 + year + (1 | id),
                    data = skin.data,
                    nAGQ = 1, # 1 point evaluated = Laplace approximation
                    family = poisson(link = "log"))
skin.glm.summary <- summary(skin.glmer)
skin.glm.coef <- coef(skin.glm.summary)
```

#TODO: Create table with parameter estimates, standard errors, z scores, p-values

#TODO: Interpret the year term

#### d) Are the estimates for the fixed intercept terms the same or different in the GLMM compared with the marginal model fitted in question 2a? Why are they the same or different?

#TODO: Compare GEE and GLMM model parameter estimates for intercept. Probably different because GLMM model has random intercept while GEE does not.

#### e) Use the parameter estimates from your GLMM and your model definition to characterize the distribution of expected counts of new skin cancers among subjects at center 1 during their first year of follow-up.

#TODO: Calculate value based on parameter estimates. Need to use language appropriate for GLMM, i.e. subject-specific.

## Optional Extra Credit Problem
<!--
(This problem is meant to offer another chance to demonstrate understanding of some of the material on the mid-term. If you choose to do this problem and your score is
higher than your mid-term grade, then your mid-term grade will be reweighted to be New Midterm Grade = .7*Old Midterm Grade + .3*Extra Credit Problem).

Onychomycosis, popularly known as toenail fungus, is a fairly common condition that not only can disfigure and sometimes destroy the nail but that also can lead to social and self-image issues for sufferers. Tight-fitting shoes or hosiery, the sharing of common facilities such as showers and locker rooms, and toenail polish are all thought to be implicated in the development of onychomycosis. This question relates to data from a study conducted by researchers that recruited sufferers of a particular type of onychomycosis, dermatophyte onychomycosis. The study conducted by the researchers was focused on comparison of two oral medications, terbinafine (given as 250 mg/day, denoted as treatment 1 below) and itraconazole (given as 200 mg/day, denoted as treatment 2 below). The trial was conducted as follows. 200 sufferers of advanced toenail dermatophyte onychomycosis in the big toe were recruited, and each saw a physician, who removed the afflicted nail. Each subject was then randomly assigned to treatment with either terbinafine (treatment 1) or itraconazole (treatment 2). Immediately prior to beginning treatment, the length of the unafflicted part of the toenail (which was hence not removed) was recorded (in millimeters). Then at 1 month, 2 months, 3 months, 6 months, and 12 months, each subject returned, and the length of the unafflicted part of the nail was measured again. A longer unafflicted nail length is a better outcome. Also recorded on each subject was gender and an indicator of the frequency with which the subject visited a gym or health club (and hence might use shared locker rooms and/or showers).

The data are available in the file toenail.txt on the class web page. The data are presented in the form of one data record per observation; the columns of the data set are as follows:
1 Subject id
2 Health club frequency indicator (= 0 if once a week or less, = 1 if more than once a
week)
3 Gender indicator (= 0 if female, = 1 if male)
4 Month
5 Unafflicted nail length (the response, mm)
6 Treatment indicator (= 1 if terbinafine, = 2 if itraconazole)
-->

```{r read-toenail-data}
# Read the data in
toenail.data <- read.delim(file = "data/toenail.txt", header = FALSE, sep = "")

# Assign column names
colnames(toenail.data) <- c("id", "freq", "gender", "month", "length", "treatment")
```

### The researchers had several questions, which they stated to you as follows:
### 1. Is there a difference in the pattern of change of lengths of the unafflicted part of the nail between subjects receiving terbinafine and itraconazole over a 12 month period? Does one treatment show results more quickly?

#TODO: Define the model
#TODO: Define the hypothesis
#TODO: Run the model, getting estimates and p-values
#TODO: Interpret support or not for hypothesis

### 2. Is there an association between the pattern of change of nail lengths and gender and/or health club frequency in subjects taking terbinafine? This might indicate that this drug brings about relief more swiftly in some kinds of subject versus others.

#TODO: Define the model
#TODO: Define the hypothesis
#TODO: Run the model, getting estimates and p-values
#TODO: Interpret support or not for hypothesis

### 3. In answering these scientific questions of interest, clearly write out the analytic models you consider for answering these questions. Clearly outline your decision making process for how you selected your final models. Fit your chosen final models and report to the project investigators on the stated scientific questions of interest.

***
The R code used in this assignment can be found in a corresponding R Markdown document at [https://github.com/jcoliver/bios-684/blob/master/final-exam-oliver.Rmd](https://github.com/jcoliver/bios-684/blob/master/final-exam-oliver.Rmd).
