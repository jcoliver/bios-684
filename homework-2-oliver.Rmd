---
title: "Homework 2"
subtitle: "BIOS 684"
author: "Jeff Oliver"
date: "15 September 2017"
output: 
  pdf_document:
  latex_engine: xelatex
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

<!--
DUE: Wednesday 20 September 2017

Instructions:
1. For each question requiring data analysis, support your conclusions by including the
relevant SAS output in your answer.
2. Include your SAS program as an Appendix to your solutions (PLEASE don’t include
the output from your program!).

Joint Modeling of Mean and Covariance in the Dental Growth Study
In a study of dental growth, measurements of the distance (mm) from the center of the
pituitary gland to the pteryomaxillary fissure were obtained on 11 girls and 16 boys at
ages 8, 10, 12 and 14 years (Potthoff and Roy, 1964).

The data are in the file “dental.txt” on the D2L dataset folder. Each row of the data
set contains the following six variables: subject ID, gender (“F” or “M”), and the
measurements at ages 8, 10, 12 and 14 years, respectively.

For all analyses in this homework, subset the dataset to contain only the
measurements for the girls.
-->

```{r echo = FALSE}
# Read in data
dental.data <- read.csv(file = "data/dental.csv",
                        header = FALSE)

# Sampling vector for later use
years <- c(8, 10, 12, 14)

# Add column names
colnames(dental.data) <- c("ID", "gender", paste0("y.", years))

# Subset data
dental.data <- dental.data[dental.data$gender == "F", ]
```


## PART A: Descriptive Analyses
### 1. Plot the observed trajectories of distance for the 11 girls (all on one plot). Briefly, describe the important patterns that are apparent in the plot. (hint: use proc gplot)

The plot below shows pairwise comparisons between measurements of the same subject at different time points (below diagonal) and the correlation coefficient (r^2^) for the relationship (above diagonal):
```{r echo = FALSE}
# Function to print correlation coefficient; copied shamelessly from pairs documentation
panel.cor <- function(x, y, digits = 2, prefix = "", cex.cor, ...) {
    usr <- par("usr"); on.exit(par(usr))
    par(usr = c(0, 1, 0, 1))
    r <- abs(cor(x, y))
    txt <- format(c(r, 0.123456789), digits = digits)[1]
    txt <- paste0(prefix, txt)
    if(missing(cex.cor)) cex.cor <- 0.8/strwidth(txt)
    text(0.5, 0.5, txt, cex = cex.cor * r)
}

# Create scatterplot of matrices to inspect data
pairs(dental.data[, 3:6], 
      labels = c("Year 8", "Year 10", "Year 12", "Year 14"),
      upper.panel = panel.cor)
```

There is high **within-subject positive correlation** between pairs of sampling times. Interestingly, the within-subject correlation does not appear to decrease much with time (e.g. the correlation coefficient between year 8 and year 10 is effectively the same as between year 8 and year 14).

### 2. Obtain descriptive statistics for the distances in girls including means and standard deviations at each measurement occasion. Plot the means against time and comment on the shape of their trajectory. Also, comment on how the standard deviations are changing with time.

```{r echo = FALSE}
distance.means <- colMeans(x = dental.data[, 3:6])
distance.sd <- apply(X = dental.data[, 3:6], MARGIN = 2, FUN = sd)
```

|Year|Mean|Standard Deviation|
|:--:|:--:|:----------------:|
| `r years[1]` | `r round(distance.means[1], 2)` | `r round(distance.sd[1], 2)` |
| `r years[2]` | `r round(distance.means[2], 2)` | `r round(distance.sd[2], 2)` |
| `r years[3]` | `r round(distance.means[3], 2)` | `r round(distance.sd[3], 2)` |
| `r years[4]` | `r round(distance.means[4], 2)` | `r round(distance.sd[4], 2)` |

```{r echo = FALSE}
plot(x = c(8, 10, 12, 14),
     y = distance.means,
     xlab = "Measurement year",
     ylab = "Mean distance (mm)",
     main = "Mean distance over time")
```

The mean distance between the center of the pituitary gland to the pteryomaxillary fissure is increasing over time.

```{r echo = FALSE}
plot(x = c(8, 10, 12, 14),
     y = distance.sd,
     xlab = "Measurement year",
     ylab = "Distance standard deviation (mm)",
     main = "Standard deviation over time")
```

Standard deviations are _not_ constant through time, illustrating **heterogeneity in variation**. In general, standard deviations appear to increase over time, although this is not absolute, as year 10 has the lowest standard deviation.

### 3. Obtain the variance-covariance and correlation matrices for the repeated measurements over time. Briefly, describe the important patterns in the correlations.

The variance-covariance matrix:
```{r echo = FALSE}
cov(dental.data[, 3:6])
```

The correlation matrix:
```{r echo = FALSE}
cor(dental.data[, 3:6])
```

There is high within-subject correlation between measurements at different times ($|\rho| >> 0$ for all pairwise comparisons).

### 4. Identify one unexpected feature of this correlation structure generated in question 3. Provide a possible reason for this unexpected feature.

There appears little change in the correlation matrix over time. This is in contrast to the expectation that correlations should decrease with increasing time separation. There could be little room for change to occur over the developmental period in which the measurements were taken. That is, if most of the growth between the pituitary gland to the pteryomaxillary fissure occurs before age eight in girls, we would expect little change in the correlation between distance measurements at different time points after eight years.

## PART B: Repeated Measures Models
### 5. Use PROC MIXED to fit a repeated measures model in which there is separate parameter for the mean distance at each of the four ages [HINT: Use the NOINT option on the MODEL statement]. Use an unstructured variance-covariance structure. For estimating parameters, fit the model using (i) the METHOD=ML option and (ii) the METHOD=REML option on the PROC MIXED statement.

```{r echo = FALSE}
library(tidyr)
# Convert to "long format"
dental.long <- gather(data = dental.data, 
                         key = year, 
                         value = distance,
                         -ID, -gender)
# Add column for treating year as a number
dental.long$year.num <- as.numeric(gsub(pattern = "y.", "", x = dental.long$year))

# Make sure our year column is treated as a factor
dental.long$year <- factor(dental.long$year, levels = paste0("y.", years))

# Run generalized least squares to get model for variance-covariance matrices?
```


#### a. Does either method of estimation give the same estimates of the variances and covariances as in your answer to question 3? If so, which one or ones?

#### b. Compare the variances and covariances for the two methods of estimation (i.e. ML versus REML). If they are not the same, comment on why they are different and state which method should be preferred and why?

**Check & revise language**: Different because ML is a biased estimator of the variance-covariance matrix ($\sigma$)because it is based on estimated beta hats; in contrast, REML <description of what REML is doing to create an unbiased estimator of the variance-covariance matrix> is an unbiased esimator of $\sigma$. Describe when to use which one.

#### c. Compare the estimated betas in the regression model to the sample means calculated in question 2. Provide a reason for any relationship you notice between these two sets of estimates.

### 6. Using METHOD=ML and an unstructured variance-covariance structure, fit a model which assumes that the mean distance changes linearly with time.

#### a. Why can this model be considered to be nested within the model fitted in question 5?

#### b. By undertaking a likelihood ratio test, evaluate the goodness of fit of this model compared with the model fitted (with METHOD=ML) in question 5. Which model do you prefer and why?

#### c. Why should you not use the REML log likelihood to compare models in this question?
Describe how REML creates non-nested models
